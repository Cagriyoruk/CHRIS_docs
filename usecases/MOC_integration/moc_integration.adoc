= MOC Integration

== Abstract

This document describes the steps that are required to get ChRIS with `legacy pman(v2.2.4)` up and running on the MOC. The intended audience is ChRIS developers.

. xref:#registering-to-mass-open-cloud[Registering to Mass Open Cloud]
. xref:#adding-projects-to-openshift-and-openstack[Adding Projects to Openshift and Openstack]
. xref:#installing-openshift-cli-tool[Installing Openshift CLI Tool]
. xref:#creating-secrets-on-openshift-using-cli-tool[Creating Secrets on Openshift Using CLI Tool]
. xref:#deploying-pfioh-on-openshift[Deploying pfioh on Openshift]
. xref:#deploying-pman-on-openshift[Deploying pman on Openshift]
. xref:#running-test-scripts-on-openshift[Running Test Scripts on Openshift]
. xref:#additional-step-building-a-local-openshift-cluster[(Additional Step) Building a Local Openshift Cluster]

== Registering to Mass Open Cloud

* In order to create an account, you should submit a request to MOC. It usually takes 2-3 business days to get approved. + 
Follow this link -> https://massopen.cloud/request-an-account/[Request Account on MOC]

* Learn more about adding users to your Openstack project. Follow this link -> https://support.massopen.cloud/kb/faq.php?id=22[Add Users to Openstack Project]

* If your access is approved, Follow these links to login to the Openshift and Openstack platforms -> https://k-openshift.osh.massopen.cloud:8443/[Openshift] | http://kaizen.massopen.cloud/[Openstack]

You should be able to login to these platforms by using your `SSO` credentials.


== Adding Projects to Openshift and Openstack

In order to create new projects on Openshift and Openstack you can create a ticket here -> https://osticket.massopen.cloud/[Create a Ticket]

If the projects are created, you should be able to login and view the projects.

Use your `SSO` credentials to login to https://kaizen.massopen.cloud to view your project in Openstack. (See the image below)

image::https://github.com/Cagriyoruk/CHRIS_docs/blob/master/images/mpc/Openstack-project.png[Openstack Project]

Use your `SSO` credentials to login to https://k-openshift.osh.massopen.cloud:8443 to view your project in Openshift. (See the image below)

image::https://github.com/Cagriyoruk/CHRIS_docs/blob/master/images/mpc/Openshift-project.png[Openshift Project]

You can create a project manually in the Openshift UI or by using a terminal command:

....
$ oc new-project cs6620-sp2021-integrated-med-ai --display-name="CS6620 Spring 2021 \
Integrating Medical AI Compute CPU/GPU worklows on the MOC -- PowerPC and x86-64 -- Using OpenShift"
....

Note: Make sure that you have OC libraries installed on your system. (See xref:#installing-openshift-cli-tool[Installing Openshift CLI Tool]
)

== Installing Openshift CLI Tool

It is recommended to install the Openshift CLI Tool on your system to ease the next steps working on MOC platform smoothly.

=== Recommended Method

In order to download the Openshift CLI Tool, you will have to create/open a RedHat account. This method is reccomended in order to get the most up to date OC libraries.

Follow this link to get information on how to download and install the Openshift CLI Tool -> https://docs.openshift.com/container-platform/4.6/cli_reference/openshift_cli/getting-started-cli.html[Download Openshift CLI Tool]

=== Alternative Method (Deprecated)

If you do not wish to create a RedHat account, you can download the packages from this GitHub repo: https://github.com/openshift/origin/releases

== Creating Secrets on Openshift Using CLI Tool

After succesfully installing Openshift CLI Tool, you can login to Opeshift using CLI commands.

First go to https://k-openshift.osh.massopen.cloud:8443/[Openshift] and login using `SSO` credentials. After that click `Copy Login Command` as seen from the image below. 

image::https://github.com/Cagriyoruk/CHRIS_docs/blob/master/images/mpc/Openshift-login.png[Openshift Login]

Open a terminal and paste the login command. (Your token will differ from the example)

....
$ oc login https://k-openshift.osh.massopen.cloud:8443 --token=MQCsXU6Gs1DWNE0zk67eYA0A7eCmH0-cM576qZooRFY
....

=== Creating Secrets

==== Create `kubecfg`

....
oc project myproject
oc create secret generic kubecfg --from-file=$HOME/.kube/config -n myproject
....

==== Create `pfioh_config & pman_config`

["loweralpha", start=1]
. Create a file `example-config.cfg` and add the following:

....
[AUTH TOKENS]
token = password
....

["loweralpha", start=2]
. Convert the configuration to base64 & copy the base64 encoded results with the following command:

....
cat example-config.cfg | base64
....

["loweralpha", start=3]
. Create a file `example-secret.yml` and add the encoded result (For `pfioh`):

....
apiVersion: v1
kind: Secret
metadata:
  name: pfioh-config
type: Opaque
data:
  pfioh_config.cfg: <base64 encoded configuration>
....

["loweralpha", start=4]
. Create the secret for `pfioh`

....
oc create -f example-secret.yml
....

["loweralpha", start=5]
. Edit the file example-secret.yml and add the following (For `pman`):

....
apiVersion: v1
kind: Secret
metadata:
  name: pman-config
type: Opaque
data:
  pman_config.cfg: <base64 encoded configuration>
....

["loweralpha", start=6]
. Create the secret for `pman`

....
oc create -f example-secret.yml
....

==== Create `swift-credentials`

["loweralpha", start=1]
. Create a file swift-credentials.cfg and add the following:

....
[AUTHORIZATION]
osAuthUrl          = https://kaizen.massopen.cloud:13000/v3

[SECRET]
applicationId      = <Follow the below steps to generate applicationId>
applicationSecret  = <Follow the below steps to generate applicationSecret>
....

Follow these steps to create and `applicationId` and `applicationSecret` for the Openstack project:

....
    1) Visit the identity panel at https://onboarding.massopen.cloud/identity/
    2) Click the "+ Create Application Credential" button
    3) In the follow dialog, give your credential a name. You can leave the other fields blank.
    4) Click "Create Application Credential"
    5) This will present a window with an ID and secret. Record these values because you won't be able to retrieve them after closing the window.
....

["loweralpha", start=2]
. Create the secret `swift-credentials`

....
oc create secret generic swift-credentials --from-file=<path-to-file>/swift-credentials.cfg
....

If all the steps above went well, you should be able to see the secrets that were created succesfully

....
(chris_env) [cyoruk@localhost ChRISWORK]$ oc get secrets
NAME                       TYPE                                  DATA   AGE
builder-dockercfg-s4shq    kubernetes.io/dockercfg               1      155d
builder-token-5p9nl        kubernetes.io/service-account-token   4      155d
builder-token-xqpz2        kubernetes.io/service-account-token   4      155d
default-dockercfg-nh5s5    kubernetes.io/dockercfg               1      155d
default-token-n9lx8        kubernetes.io/service-account-token   4      155d
default-token-xb6x7        kubernetes.io/service-account-token   4      155d
deployer-dockercfg-hszz4   kubernetes.io/dockercfg               1      155d
deployer-token-fqvc5       kubernetes.io/service-account-token   4      155d
deployer-token-vcf2f       kubernetes.io/service-account-token   4      155d
kubecfg                    Opaque                                1      4d
pfioh-config               Opaque                                1      4d
pman-config                Opaque                                1      4d
swift-credentials          Opaque                                1      4d
....

== Deploying pfioh on Openshift

Follow this link to download `pfioh` -> https://github.com/FNNDSC/pfioh

After downloading it, enter the subdirectory `openshift`:

....
cd pfioh/openshift
....

To deploy `pfioh` on Openshift we need a file that contains all the information about the service we're going to deploy which is `pfioh-openshift-template.json`. 

For deploying `pfioh` to Openshift:

....
oc new-app pfioh-openshift-template.json
....

After deploying `pfioh`, you can see it deployed and running on Openshift. (See image below)

image::https://github.com/Cagriyoruk/CHRIS_docs/blob/master/images/mpc/Pfioh-Overview.png[Pfioh Overview]

To delete `pfioh`

....
oc delete all -l app=pfioh
oc delete route pfioh
....

=== Deploying your own version of `pfioh` 

If you want to deploy your own version of `pfioh` you can edit `pfioh-openshift-template.json` which is present in pfioh/openshift. You will find a line containing "image": "fnndsc/pfioh", which is basically the name of the docker image we want to deploy. As an example you can change it to sandip117/pfioh. So it would look like "image": "sandip117/pfioh". (See the image below)

image::https://github.com/Cagriyoruk/CHRIS_docs/blob/master/images/mpc/Pfioh-template.png[Pfioh Template]

Note: The current version that supports `SSO` is `fnndsc/pfioh`

== Deploying pman on Openshift

== Running Test Scripts on Openshift

== (Additional Step) Building a Local Openshift Cluster

Note: This step is focused on bringing a minimal `OpenShift 4.x` cluster to your local laptop or desktop computer. If you are looking for a solution for running `OpenShift 3.x` , you will need tools such as oc cluster up, https://github.com/minishift/minishift[Minishift] or https://developers.redhat.com/products/cdk/overview[CDK].

This additional step is helpful for people who build ChRIS plugins/services to test/debug applications locally before testing it on the cloud environment.

There are couple steps involved to build a local `Openshift 4.x` cluster.

* xref:#download-codeready-containers[Download CodeReady Containers]

* xref:#install-codeready-containers[Install CodeReady Containers]

* xref:#setup-openshift-cluster[Setup Openshift Cluster]

=== Download CodeReady Containers

Select your OS and Download CodeReady Containers binaries with an embedded OpenShift disk image from https://cloud.redhat.com/openshift/create/local[CodeReady Containers] (See Image Below)

image:https://github.com/Cagriyoruk/CHRIS_docs/blob/master/images/mpc/CodeReady-Containers.png[CodeReady Containers]


After downloading CodeReady containers, extract it and place the executable in your `$PATH` (You can check your `$PATH` with `$ echo $PATH`)


....
$ tar -xf crc-linux-amd64.tar.xz (Extract CodeReady Containers)
$ cp -r crc-linux-amd64 $PATH (Place the executable in one of your $PATH)
....

You need to Download or copy your pull secret. The install program will prompt you for your pull secret during installation.

Note: In order to download the CodeReady Containers, you will have to create/open a RedHat account.

=== Install CodeReady Containers

CodeReady Containers requires the libvirt and NetworkManager packages to run on Linux. Consult the following code block to find the command used to install these packages for your Linux distribution:

* Fedora -> `sudo dnf install NetworkManager`

* Red Hat Enterprise Linux/CentOS -> `su -c 'yum install NetworkManager'`

* Debian/Ubuntu -> `sudo apt install qemu-kvm libvirt-daemon libvirt-daemon-system network-manager`

Set up the CodeReady Containers

....
$ crc setup
....

Start the CodeReady Containers virtual machine:

....
$ crc start
....


=== Setup ChRIS on Local Openshift Cluster

